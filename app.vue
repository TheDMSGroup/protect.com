<script setup>
import { useStore } from "~/stores/store";

const store = useStore();

useHead({
  script: [
    {
      src: '/lib/geoip2.js',
      id: 'geoip2',
      async: true
    }
  ]
});

// Traffic source detection
const ORGANIC_DOMAINS = new Set([
  "360.cn",
  "alice",
  "aol",
  "ar.search.yahoo.com",
  "ask",
  "at.search.yahoo.com",
  "athlinks.com",
  "au.search.yahoo.com",
  "auone",
  "avg",
  "babylon",
  "baidu",
  "bharatstudent.com",
  "biglobe",
  "biglobe.co.jp",
  "biglobe.ne.jp",
  "biip.no",
  "bing",
  "br.search.yahoo.com",
  "buzznet.com",
  "ca.search.yahoo.com",
  "centrum.cz",
  "ch.search.yahoo.com",
  "chat.zalo.me",
  "cl.search.yahoo.com",
  "classmates",
  "classquest.com",
  "cn.bing.com",
  "cnn",
  "co.search.yahoo.com",
  "comcast",
  "conduit",
  "daum",
  "daum.net",
  "de.search.yahoo.com",
  "dk.search.yahoo.com",
  "dogpile",
  "dogpile.com",
  "dogster",
  "duckduckgo",
  "ecosia.org",
  "edublogs.org",
  "email.seznam.cz",
  "eniro",
  "es.search.yahoo.com",
  "espanol.search.yahoo.com",
  "exalead.com",
  "excite.com",
  "fi.search.yahoo.com",
  "firmy.cz",
  "fr.search.yahoo.com",
  "globo",
  "go.mail.ru",
  "google",
  "google-play",
  "googlegroups.com",
  "hi5.com",
  "hk.search.yahoo.com",
  "id.search.yahoo.com",
  "in.search.yahoo.com",
  "incredimail",
  "it.search.yahoo.com",
  "kvasir",
  "lens.google.com",
  "lite.qwant.com",
  "lycos",
  "m.baidu.com",
  "m.naver.com",
  "m.search.naver.com",
  "m.sogou.com",
  "mail.yandex.ru",
  "malaysia.search.yahoo.com",
  "msn",
  "msn.com",
  "mx.search.yahoo.com",
  "naver",
  "naver.com",
  "news.google.com",
  "nl.search.yahoo.com",
  "no.search.yahoo.com",
  "ntp.msn.com",
  "nz.search.yahoo.com",
  "onet",
  "pe.search.yahoo.com",
  "ph.search.yahoo.com",
  "pl.search.yahoo.com",
  "play.google.com",
  "qwant",
  "qwant.com",
  "qzone.qq.com",
  "rakuten",
  "rakuten.co.jp",
  "rambler",
  "scvngr.com",
  "se.search.yahoo.com",
  "search-results",
  "search.aol.co.uk",
  "search.aol.com",
  "search.google.com",
  "search.smt.docomo.ne.jp",
  "search.ukr.net",
  "secondlife",
  "secureurl.ukr.net",
  "seznam",
  "seznam.cz",
  "sg.search.yahoo.com",
  "so.com",
  "sogou",
  "sogou.com",
  "sp-web.search.auone.jp",
  "startsiden",
  "startsiden.no",
  "suche.aol.de",
  "terra",
  "th.search.yahoo.com",
  "tr.search.yahoo.com",
  "tw.search.yahoo.com",
  "uk.search.yahoo.com",
  "uk.shopping.net",
  "ukr",
  "us.search.yahoo.com",
  "virgilio",
  "vn.search.yahoo.com",
  "wap.sogou.com",
  "webmaster.yandex.ru",
  "webshots",
  "yahoo",
  "yahoo.co.jp",
  "yahoo.com",
  "yandex",
  "yandex.by",
  "yandex.com",
  "yandex.com.tr",
  "yandex.fr",
  "yandex.kz",
  "yandex.ru",
  "yandex.ua",
  "yandex.uz",
  "zen.yandex.ru"
]);
// get the list
const SOCIALS = new Set([
  "43things",
  "43things.com",
  "51.com",
  "5ch.net",
  "Hatena",
  "ImageShack",
  "academia.edu",
  "activerain",
  "activerain.com",
  "activeworlds",
  "activeworlds.com",
  "addthis",
  "addthis.com",
  "airg.ca",
  "allnurses.com",
  "allrecipes.com",
  "alumniclass",
  "alumniclass.com",
  "ameba.jp",
  "ameblo.jp",
  "americantowns",
  "americantowns.com",
  "amp.reddit.com",
  "ancestry.com",
  "anobii",
  "anobii.com",
  "answerbag",
  "answerbag.com",
  "answers.yahoo.com",
  "aolanswers",
  "aolanswers.com",
  "apps.facebook.com",
  "ar.pinterest.com",
  "artstation.com",
  "askubuntu",
  "askubuntu.com",
  "asmallworld.com",
  "athlinks",
  "athlinks.com",
  "away.vk.com",
  "awe.sm",
  "b.hatena.ne.jp",
  "baby-gaga",
  "baby-gaga.com",
  "babyblog.ru",
  "badoo",
  "badoo.com",
  "bebo",
  "bebo.com",
  "beforeitsnews",
  "beforeitsnews.com",
  "bharatstudent",
  "bharatstudent.com",
  "biip.no",
  "biswap.org",
  "bit.ly",
  "blackcareernetwork.com",
  "blackplanet",
  "blackplanet.com",
  "blip.fm",
  "blog.com",
  "blog.feedspot.com",
  "blog.goo.ne.jp",
  "blog.naver.com",
  "blog.yahoo.co.jp",
  "blogg.no",
  "bloggang.com",
  "blogger",
  "blogger.com",
  "blogher",
  "blogher.com",
  "bloglines",
  "bloglines.com",
  "blogs.com",
  "blogsome",
  "blogsome.com",
  "blogspot",
  "blogspot.com",
  "blogster",
  "blogster.com",
  "blurtit",
  "blurtit.com",
  "bookmarks.yahoo.co.jp",
  "bookmarks.yahoo.com",
  "br.pinterest.com",
  "brightkite",
  "brightkite.com",
  "brizzly",
  "brizzly.com",
  "business.facebook.com",
  "buzzfeed",
  "buzzfeed.com",
  "buzznet",
  "buzznet.com",
  "cafe.naver.com",
  "cafemom",
  "cafemom.com",
  "camospace",
  "camospace.com",
  "canalblog.com",
  "care.com",
  "care2",
  "care2.com",
  "caringbridge.org",
  "catster",
  "catster.com",
  "cbnt.io",
  "cellufun",
  "cellufun.com",
  "centerblog.net",
  "chat.zalo.me",
  "chegg.com",
  "chicagonow",
  "chicagonow.com",
  "chiebukuro.yahoo.co.jp",
  "classmates",
  "classmates.com",
  "classquest",
  "classquest.com",
  "co.pinterest.com",
  "cocolog-nifty",
  "cocolog-nifty.com",
  "copainsdavant.linternaute.com",
  "couchsurfing.org",
  "cozycot",
  "cozycot.com",
  "cross.tv",
  "crunchyroll",
  "crunchyroll.com",
  "cyworld",
  "cyworld.com",
  "cz.pinterest.com",
  "d.hatena.ne.jp",
  "dailystrength.org",
  "deluxe.com",
  "deviantart",
  "deviantart.com",
  "dianping",
  "dianping.com",
  "digg",
  "digg.com",
  "diigo",
  "diigo.com",
  "discover.hubpages.com",
  "disqus",
  "disqus.com",
  "dogster",
  "dogster.com",
  "dol2day",
  "dol2day.com",
  "doostang",
  "doostang.com",
  "dopplr",
  "dopplr.com",
  "douban",
  "douban.com",
  "draft.blogger.com",
  "draugiem.lv",
  "drugs-forum",
  "drugs-forum.com",
  "dzone",
  "dzone.com",
  "edublogs.org",
  "elftown",
  "elftown.com",
  "epicurious.com",
  "everforo.com",
  "exblog.jp",
  "extole",
  "extole.com",
  "facebook",
  "facebook.com",
  "faceparty",
  "faceparty.com",
  "fandom.com",
  "fanpop",
  "fanpop.com",
  "fark",
  "fark.com",
  "fb",
  "fb.me",
  "fc2",
  "fc2.com",
  "feedspot",
  "feministing",
  "feministing.com",
  "filmaffinity",
  "filmaffinity.com",
  "flickr",
  "flickr.com",
  "flipboard",
  "flipboard.com",
  "folkdirect",
  "folkdirect.com",
  "foodservice",
  "foodservice.com",
  "forums.androidcentral.com",
  "forums.crackberry.com",
  "forums.imore.com",
  "forums.nexopia.com",
  "forums.webosnation.com",
  "forums.wpcentral.com",
  "fotki",
  "fotki.com",
  "fotolog",
  "fotolog.com",
  "foursquare",
  "foursquare.com",
  "free.facebook.com",
  "friendfeed",
  "friendfeed.com",
  "fruehstueckstreff.org",
  "fubar",
  "fubar.com",
  "gaiaonline",
  "gaiaonline.com",
  "gamerdna",
  "gamerdna.com",
  "gather.com",
  "geni.com",
  "getpocket.com",
  "glassboard",
  "glassboard.com",
  "glassdoor",
  "glassdoor.com",
  "godtube",
  "godtube.com",
  "goldenline.pl",
  "goldstar",
  "goldstar.com",
  "goo.gl",
  "gooblog",
  "goodreads",
  "goodreads.com",
  "google+",
  "googlegroups.com",
  "googleplus",
  "govloop",
  "govloop.com",
  "gowalla",
  "gowalla.com",
  "gree.jp",
  "groups.google.com",
  "gulli.com",
  "gutefrage.net",
  "habbo",
  "habbo.com",
  "hi5",
  "hi5.com",
  "hootsuite",
  "hootsuite.com",
  "houzz",
  "houzz.com",
  "hoverspot",
  "hoverspot.com",
  "hr.com",
  "hu.pinterest.com",
  "hubculture",
  "hubculture.com",
  "hubpages.com",
  "hyves.net",
  "hyves.nl",
  "ibibo",
  "ibibo.com",
  "id.pinterest.com",
  "identi.ca",
  "ig",
  "imageshack.com",
  "imageshack.us",
  "imvu",
  "imvu.com",
  "in.pinterest.com",
  "insanejournal",
  "insanejournal.com",
  "instagram",
  "instagram.com",
  "instapaper",
  "instapaper.com",
  "internations.org",
  "interpals.net",
  "intherooms",
  "intherooms.com",
  "irc-galleria.net",
  "is.gd",
  "italki",
  "italki.com",
  "jammerdirect",
  "jammerdirect.com",
  "jappy.com",
  "jappy.de",
  "kaboodle.com",
  "kakao",
  "kakao.com",
  "kakaocorp.com",
  "kaneva",
  "kaneva.com",
  "kin.naver.com",
  "l.facebook.com",
  "l.instagram.com",
  "l.messenger.com",
  "last.fm",
  "librarything",
  "librarything.com",
  "lifestream.aol.com",
  "line",
  "line.me",
  "linkedin",
  "linkedin.com",
  "listal",
  "listal.com",
  "listography",
  "listography.com",
  "livedoor.com",
  "livedoorblog",
  "livejournal",
  "livejournal.com",
  "lm.facebook.com",
  "lnkd.in",
  "m.blog.naver.com",
  "m.cafe.naver.com",
  "m.facebook.com",
  "m.kin.naver.com",
  "m.vk.com",
  "m.yelp.com",
  "mbga.jp",
  "medium.com",
  "meetin.org",
  "meetup",
  "meetup.com",
  "meinvz.net",
  "meneame.net",
  "menuism.com",
  "messages.google.com",
  "messages.yahoo.co.jp",
  "messenger",
  "messenger.com",
  "mix.com",
  "mixi.jp",
  "mobile.facebook.com",
  "mocospace",
  "mocospace.com",
  "mouthshut",
  "mouthshut.com",
  "movabletype",
  "movabletype.com",
  "mubi",
  "mubi.com",
  "my.opera.com",
  "myanimelist.net",
  "myheritage",
  "myheritage.com",
  "mylife",
  "mylife.com",
  "mymodernmet",
  "mymodernmet.com",
  "myspace",
  "myspace.com",
  "netvibes",
  "netvibes.com",
  "news.ycombinator.com",
  "newsshowcase",
  "nexopia",
  "ngopost.org",
  "niconico",
  "nicovideo.jp",
  "nightlifelink",
  "nightlifelink.com",
  "ning",
  "ning.com",
  "nl.pinterest.com",
  "odnoklassniki.ru",
  "odnoklassniki.ua",
  "okwave.jp",
  "old.reddit.com",
  "oneworldgroup.org",
  "onstartups",
  "onstartups.com",
  "opendiary",
  "opendiary.com",
  "oshiete.goo.ne.jp",
  "out.reddit.com",
  "over-blog.com",
  "overblog.com",
  "paper.li",
  "partyflock.nl",
  "photobucket",
  "photobucket.com",
  "pinboard",
  "pinboard.in",
  "pingsta",
  "pingsta.com",
  "pinterest",
  "pinterest.at",
  "pinterest.ca",
  "pinterest.ch",
  "pinterest.cl",
  "pinterest.co.kr",
  "pinterest.co.uk",
  "pinterest.com",
  "pinterest.com.au",
  "pinterest.com.mx",
  "pinterest.de",
  "pinterest.es",
  "pinterest.fr",
  "pinterest.it",
  "pinterest.jp",
  "pinterest.nz",
  "pinterest.ph",
  "pinterest.pt",
  "pinterest.ru",
  "pinterest.se",
  "pixiv.net",
  "pl.pinterest.com",
  "playahead.se",
  "plurk",
  "plurk.com",
  "plus.google.com",
  "plus.url.google.com",
  "pocket.co",
  "posterous",
  "posterous.com",
  "pro.homeadvisor.com",
  "pulse.yahoo.com",
  "qapacity",
  "qapacity.com",
  "quechup",
  "quechup.com",
  "quora",
  "quora.com",
  "qzone.qq.com",
  "ravelry",
  "ravelry.com",
  "reddit",
  "reddit.com",
  "redux",
  "redux.com",
  "renren",
  "renren.com",
  "researchgate.net",
  "reunion",
  "reunion.com",
  "reverbnation",
  "reverbnation.com",
  "rtl.de",
  "ryze",
  "ryze.com",
  "salespider",
  "salespider.com",
  "scoop.it",
  "screenrant",
  "screenrant.com",
  "scribd",
  "scribd.com",
  "scvngr",
  "scvngr.com",
  "secondlife",
  "secondlife.com",
  "serverfault",
  "serverfault.com",
  "shareit",
  "sharethis",
  "sharethis.com",
  "shvoong.com",
  "sites.google.com",
  "skype",
  "skyrock",
  "skyrock.com",
  "slashdot.org",
  "slideshare.net",
  "smartnews.com",
  "snapchat",
  "snapchat.com",
  "social",
  "sociallife.com.br",
  "socialvibe",
  "socialvibe.com",
  "spaces.live.com",
  "spoke",
  "spoke.com",
  "spruz",
  "spruz.com",
  "ssense.com",
  "stackapps",
  "stackapps.com",
  "stackexchange",
  "stackexchange.com",
  "stackoverflow",
  "stackoverflow.com",
  "stardoll.com",
  "stickam",
  "stickam.com",
  "studivz.net",
  "suomi24.fi",
  "superuser",
  "superuser.com",
  "sweeva",
  "sweeva.com",
  "t.co",
  "t.me",
  "tagged",
  "tagged.com",
  "taggedmail",
  "taggedmail.com",
  "talkbiznow",
  "talkbiznow.com",
  "taringa.net",
  "techmeme",
  "techmeme.com",
  "tencent",
  "tencent.com",
  "tiktok",
  "tiktok.com",
  "tinyurl",
  "tinyurl.com",
  "toolbox",
  "toolbox.com",
  "touch.facebook.com",
  "tr.pinterest.com",
  "travellerspoint",
  "travellerspoint.com",
  "tripadvisor",
  "tripadvisor.com",
  "trombi",
  "trombi.com",
  "trustpilot",
  "tudou",
  "tudou.com",
  "tuenti",
  "tuenti.com",
  "tumblr",
  "tumblr.com",
  "tweetdeck",
  "tweetdeck.com",
  "twitter",
  "twitter.com",
  "twoo.com",
  "typepad",
  "typepad.com",
  "unblog.fr",
  "urbanspoon.com",
  "ushareit.com",
  "ushi.cn",
  "vampirefreaks",
  "vampirefreaks.com",
  "vampirerave",
  "vampirerave.com",
  "vg.no",
  "video.ibm.com",
  "vk.com",
  "vkontakte.ru",
  "wakoopa",
  "wakoopa.com",
  "wattpad",
  "wattpad.com",
  "web.facebook.com",
  "web.skype.com",
  "webshots",
  "webshots.com",
  "wechat",
  "wechat.com",
  "weebly",
  "weebly.com",
  "weibo",
  "weibo.com",
  "wer-weiss-was.de",
  "weread",
  "weread.com",
  "whatsapp",
  "whatsapp.com",
  "wiki.answers.com",
  "wikihow.com",
  "wikitravel.org",
  "woot.com",
  "wordpress",
  "wordpress.com",
  "wordpress.org",
  "xanga",
  "xanga.com",
  "xing",
  "xing.com",
  "yahoo-mbga.jp",
  "yammer",
  "yammer.com",
  "yelp",
  "yelp.co.uk",
  "yelp.com",
  "youroom.in",
  "za.pinterest.com",
  "zalo",
  "zoo.gr",
  "zooppa",
  "zooppa.com"
]);
const LLM_DOMAINS_REGEX = /^.*ai|.*\.openai.*|.*copilot.*|.*chatgpt.*|.*gemini.*|.*gpt.*|.*neeva.*|.*writesonic.*|.*nimble.*|.*outrider.*|.*perplexity.*|.*google.*bard.*|.*bard.*google.*|.*bard.*|.*edgeservices.*|.*astastic.*|.*copy\.ai.*|.*bnngpt.*|.*gemini.*google.*$/;

function normalizeUrl(url) {
  return url
    .toLowerCase()
    .replace(/^https?:\/\//, '')
    .replace(/^www\./, '')
    .split('/')[0]
    .split(':')[0]
    .trim();
}

function getUeidByReferrer(referrer, urlParams = null) {
  if (!referrer && !urlParams.get('referrer')) return null;
  store.setVisitorInfo({ mst: 'r0TV0W_hUOqv_Uow4brhX-wkx5F9TQ' });

  const normalizedReferrer = urlParams.get('referrer')
    ? normalizeUrl(urlParams.get('referrer'))
    : normalizeUrl(referrer);
  const matchesDomain = (domain) => normalizedReferrer.includes(domain);
  if ([...SOCIALS].some(matchesDomain)) {
    return 'dpbosoc_auto';
  }

  if ([...ORGANIC_DOMAINS].some(matchesDomain)) {
    return 'dpbosrc_auto';
  }

  if (LLM_DOMAINS_REGEX.test(normalizedReferrer)) {
    return 'dpboai_auto';
  }
  return null;
}

// Run on client side only
onMounted(() => {
  const urlParams = new URLSearchParams(window.location.search);
  const ueid = urlParams.get('ueid');
  if (ueid) {
    store.setVisitorInfo({ ueid });
  } else {
    store.setVisitorInfo({ ueid: getUeidByReferrer(document.referrer, urlParams) });
  }
});
</script>
<template>
  <div id="protectApp">
    <NuxtLayout>
      <NuxtPage />
    </NuxtLayout>
  </div>
</template>
